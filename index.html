<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title></title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

  <style>
    body { margin: 0; padding: 0; }
    #map { width: 100%; height: 100vh; }

    /* Bigger note popup */
    .leaflet-popup-content-wrapper { width: 520px; }
    .leaflet-popup-content { width: 500px !important; margin: 14px 16px; }

    .note-popup textarea{
      width: 100%;
      height: 200px;
      resize: vertical;
      box-sizing: border-box;
      font-size: 14px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      outline: none;
    }
    .note-popup textarea:focus { border-color: #999; }

    .note-actions{
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 10px;
    }
    .note-actions button{
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #fff;
    }
    .note-actions button.primary{
      border-color: #111;
      background: #111;
      color: #fff;
    }

    /* Toast container */
    #toastRoot{
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }

    /* Toast */
    .toast{
      pointer-events: auto;
      min-width: 260px;
      max-width: 340px;
      background: rgba(20, 20, 20, 0.95);
      color: #fff;
      border-radius: 12px;
      padding: 12px 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      display: flex;
      align-items: flex-start;
      gap: 10px;
      opacity: 0;
      transform: translateY(-8px);
      transition: opacity 160ms ease, transform 160ms ease;
    }
    .toast.show{
      opacity: 1;
      transform: translateY(0);
    }
    .toast .icon{
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: rgba(255,255,255,0.14);
      display: grid;
      place-items: center;
      flex: 0 0 auto;
      font-size: 16px;
    }
    .toast .content{
      flex: 1 1 auto;
      font-size: 14px;
      line-height: 1.35;
    }
    .toast .title{
      font-weight: 600;
      margin-bottom: 2px;
    }
    .toast .actions{
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .toast button{
      border: 0;
      border-radius: 10px;
      padding: 7px 10px;
      cursor: pointer;
      font-size: 13px;
    }
    .toast .btn-undo{
      background: rgba(255,255,255,0.14);
      color: #fff;
    }
    .toast .btn-close{
      background: transparent;
      color: rgba(255,255,255,0.8);
      padding: 0 6px;
      font-size: 18px;
      line-height: 1;
      align-self: flex-start;
      margin-top: 2px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div id="toastRoot"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

  <script>
    const STORAGE_KEY = 'leaflet_drawings_with_notes_v1'
    const toastRoot = document.getElementById('toastRoot')

    const map = L.map('map').setView([-34.9285, 138.6007], 13)

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map)

    const drawnItems = new L.FeatureGroup()
    map.addLayer(drawnItems)

    // ---- Persistence ----
    function saveAll() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(drawnItems.toGeoJSON()))
    }

    function loadAll() {
      const saved = localStorage.getItem(STORAGE_KEY)
      if (!saved) return
      const geojson = JSON.parse(saved)

      L.geoJSON(geojson, {
        onEachFeature: (feature, layer) => {
          // ensure feature exists for future note updates
          layer.feature = layer.feature || feature || { type: 'Feature', properties: {} }

          // enable note popup on click
          attachNoteUI(layer)

          // optional: show note on click as regular popup (you can remove this)
          if (feature.properties?.note) layer.bindTooltip('üìù', { permanent: false })

          drawnItems.addLayer(layer)
        }
      })
    }

    // ---- Toast ----
    function showToast({ title, message, onUndo }) {
      const el = document.createElement('div')
      el.className = 'toast'
      el.innerHTML = `
        <div class="icon">‚úÖ</div>
        <div class="content">
          <div class="title">${title}</div>
          <div>${message}</div>
          ${onUndo ? `<div class="actions"><button class="btn-undo">Undo</button></div>` : ``}
        </div>
        <button class="btn-close" aria-label="Close">√ó</button>
      `
      toastRoot.appendChild(el)

      // animate in
      requestAnimationFrame(() => el.classList.add('show'))

      const close = () => {
        el.classList.remove('show')
        setTimeout(() => el.remove(), 160)
      }

      el.querySelector('.btn-close').onclick = close

      if (onUndo) {
        el.querySelector('.btn-undo').onclick = () => {
          onUndo()
          close()
        }
      }

      // auto close
      setTimeout(close, 2500)
    }

    // ---- Note Popup UI ----
    function attachNoteUI(layer) {
      const popupHtml = `
        <div class="note-popup">
          <textarea placeholder="Add a note (Sail value $, Comment)..."></textarea>
          <div class="note-actions">
            <button class="btn-cancel" type="button">Cancel</button>
            <button class="btn-save primary" type="button">Save Note</button>
          </div>
        </div>
      `

      layer.bindPopup(popupHtml, { maxWidth: 560, minWidth: 520, autoPan: true })

      layer.on('popupopen', e => {
        const popupEl = e.popup.getElement()
        const textarea = popupEl.querySelector('textarea')
        const btnSave = popupEl.querySelector('.btn-save')
        const btnCancel = popupEl.querySelector('.btn-cancel')

        layer.feature = layer.feature || { type: 'Feature', properties: {} }
        layer.feature.properties = layer.feature.properties || {}

        const previousNote = layer.feature.properties.note || ''
        textarea.value = previousNote
        textarea.focus()

        btnCancel.onclick = () => layer.closePopup()

        btnSave.onclick = () => {
          const newNote = textarea.value.trim()

          // set note
          layer.feature.properties.note = newNote
          saveAll()
          layer.closePopup()

          // friendly toast with undo
          showToast({
            title: 'Note saved',
            message: newNote ? 'Your note was saved successfully.' : 'Saved (empty note).',
            onUndo: () => {
              layer.feature.properties.note = previousNote
              saveAll()
              showToast({ title: 'Undone', message: 'Restored the previous note.' })
            }
          })
        }
      })
    }

    // ---- Draw controls ----
    const drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems },
      draw: { polygon: true, polyline: true, rectangle: true, circle: true, marker: true }
    })
    map.addControl(drawControl)

    // Created
    map.on(L.Draw.Event.CREATED, e => {
      const layer = e.layer
      layer.feature = layer.feature || { type: 'Feature', properties: {} }
      attachNoteUI(layer)
      drawnItems.addLayer(layer)
      saveAll()
      layer.openPopup()
    })

    // Edited / Deleted
    map.on(L.Draw.Event.EDITED, saveAll)
    map.on(L.Draw.Event.DELETED, saveAll)

    // Load persisted data
    loadAll()
  </script>
</body>
</html>

